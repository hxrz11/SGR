# SGR Patch (без LIMIT)

Этот патч добавляет:
- **Pydantic-схемы** для всех стадий SGR
- **Промпт-шаблоны** для Analysis/Strategy/Generation/Validation
- **AST SQL-валидатор** на `sqlglot` без авто-LIMIT
- **Tracing-декоратор** для логов по этапам
- **Пример пайплайна** с конфигурируемым whitelist

## Установка

```bash
pip install -e .
pytest -q
```

Интеграция в проект
Скопируйте директорию sgr/, tests/, pyproject.toml и README_PATCH.md в корень проекта или объедините с существующей структурой. Подключите run_pipeline в ваш обработчик запроса; пробрасывайте trace_id и user_query. Перед выполнением SQL: используйте SQLGuard.validate(sql); выполняйте параметризованно (например, psycopg/asyncpg).

Логи этапов будут в logs/<trace_id>/*.json (папку можно задать SGR_LOG_DIR).

Политика безопасности (ключевые моменты)
Разрешены только SELECT. Блокируются комментарии и несколько операторов в одном тексте. Белые списки для схем/таблиц/колонок/функций. Нет авто-LIMIT — как просили.

Дальнейшие шаги
Подключить реальные LLM-вызовы и строгую проверку JSON по schemas.py. Добавить EXPLAIN/таймауты исполнения и пост-валидацию схемы результата. Расширить тесты под вашу БД и доменную модель.
